<div id="EDIT_CONTROL">
  <div id="EDIT_STATE_TEXT">Edit mode off</div>
  <i class="fa fa-toggle-off fa-2x" id="EDIT_SWITCH"></i>
</div>

<%= editable_tag(:h1, "test-page-header") %>
<%= editable_tag(:div, "test-page-body") %>

<script>
  function disableEditors() {
    $.each(tinymce.EditorManager.editors, function(index, editor) {
      editor.hide(); 
    });
  }

  function enableEditors() {
    $.each(tinymce.EditorManager.editors, function(index, editor) {
      editor.show(); 
    });
  }

  $('#EDIT_SWITCH').click(function() {
    var switchElem = $(this)
    , textElem = $('#EDIT_STATE_TEXT');

    if (switchElem.hasClass('fa-toggle-off')) {
      switchElem.removeClass('fa-toggle-off');
      switchElem.addClass('fa-toggle-on');
      textElem.html("Edit mode on")

      enableEditors();
    } else {
      switchElem.removeClass('fa-toggle-on');
      switchElem.addClass('fa-toggle-off');
      textElem.html("Edit mode off")
      
      disableEditors();
    }
  });

  function saveCallback(editor) {
    editor.setProgressState(true);

    var element = $(editor.getElement())
      , key = element.data('content-key')
      , locale = element.data('locale')
    ;

    $.ajax('/editor_content', {
      method: "POST",
      data: {
        key: key
      , value: editor.getContent()
      , locale: locale
      },
      complete: function () {
        var showFn = function() {
          editor.show(); 
        }

        element.off('click', showFn).on('click', showFn);
        editor.hide();
        editor.setProgressState(false);
      },
      error: function() {
        alert("Oops, something went wrong! Please try again later.");
      }
    });
  }

  $(function() {  
      tinymce.init({
      selector: 'h1[data-editable="true"]',
      inline: true,
      plugins: 'paste',
      toolbar: 'undo redo',
  //    save_onsavecallback: saveCallback,
      menubar: false,
      valid_styles: {
        '*': ''
      },
      valid_elements: '',
      init_instance_callback: function(editor) {
        // start disabled
        editor.hide();
      }
    });

    tinymce.init({
      selector: 'div[data-editable="true"]',
      inline: true,
      plugins: 'paste link',
      toolbar: 'undo redo | bold italic | bullist | link',
  //   save_onsavecallback: saveCallback,
      menubar: false,
      valid_styles: {
        '*': ''
      },
      valid_elements: 'a[href],strong/b,p,br,ul,li,em',
      init_instance_callback: function(editor) {
        // start disabled
        editor.hide();
      }
    });
  });

  $('#EDIT_CONTROL').draggable({ cursor: 'move' });
</script>

